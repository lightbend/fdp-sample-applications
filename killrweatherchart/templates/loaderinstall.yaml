apiVersion: v1
kind: Pod
metadata:
  name: killrweatherdataloader
  labels:
    fdpmanager : visible
spec:
  containers:
  - name: killrweatherdataloader
    image: {{ .Values.image.loader}}:{{.Values.image.version }}
    imagePullPolicy: {{ .Values.image.pullPolicy }}
    env:
      - name: KAFKA_BROKERS
        value: {{ .Values.configuration.kafka.brokerlist}}
      - name: PUBLISH_INTERVAL
        value: {{ .Values.configuration.loader.publish_interval}}
      - name: DATA_DIRECTORY
        value: {{ .Values.configuration.loader.data_mount}}/data/load/
      - name: DATA_BATCH_SIZE
        value: {{ .Values.configuration.loader.batch_size}}
    volumeMounts:
    - name: datadir
      mountPath: {{ .Values.configuration.loader.data_mount}}
  # These container runs during pod initialization
  initContainers:
  - name: install
    image: busybox
    command:
    - sh
    - -c
    - wget {{ .Values.data.datadirectory }} -O {{ .Values.configuration.loader.data_mount}}/data.zip; unzip {{ .Values.configuration.loader.data_mount}}/data.zip -d {{ .Values.configuration.loader.data_mount}}/
    volumeMounts:
    - name: datadir
      mountPath: {{ .Values.configuration.loader.data_mount}}
  dnsPolicy: Default
  volumes:
  - name: datadir
    emptyDir: {}

{{ if eq .Values.components.http "yes" }}
-----
apiVersion: v1
kind: Pod
metadata:
  name: killrweatherhttpclient
  labels:
    fdpmanager : visible
spec:
  containers:
  - name: killrweatherhttpclient
    image: {{ .Values.image.http }}:{{.Values.image.version }}
    env:
      - name: KAFKA_BROKERS
        value: {{ .Values.configuration.kafka.brokerlist}}
{{ end }}

{{ if eq .Values.components.grpc "yes" }}
---------
apiVersion: v1
kind: Pod
metadata:
  name: killrweathergrpcclient
  labels:
    fdpmanager : visible
spec:
  containers:
  - name: killrweathergrpcclient
    image: {{ .Values.image.grpc }}:{{.Values.image.version }}
    env:
      - name: KAFKA_BROKERS
        value: {{ .Values.configuration.kafka.brokerlist}}
{{ end }}